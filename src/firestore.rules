
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures the `/properties` collection.
     */
    match /properties/{propertyId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && isOwner(request.resource.data.ownerId);
      allow update, delete: if isSignedIn() && isOwner(resource.data.ownerId);
    }

    /**
     * @description Secures the `/revenue` collection.
     */
    match /revenue/{transactionId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && isOwner(request.resource.data.ownerId);
      allow update, delete: if isSignedIn() && isOwner(resource.data.ownerId);
    }

    /**
     * @description Secures the `/expenses` collection.
     */
    match /expenses/{transactionId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && isOwner(request.resource.data.ownerId);
      allow update, delete: if isSignedIn() && isOwner(resource.data.ownerId);
    }

    /**
     * @description Secures the `/maintenanceRequests` collection.
     */
    match /maintenanceRequests/{requestId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && isOwner(request.resource.data.ownerId);
      allow update, delete: if isSignedIn() && isOwner(resource.data.ownerId);
    }

    /**
     * @description Secures the `/contractors` collection.
     */
    match /contractors/{contractorId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && isOwner(request.resource.data.ownerId);
      allow update, delete: if isSignedIn() && isOwner(resource.data.ownerId);
    }

     /**
      * @description Secures the `/changelog` collection.
      */
    match /changelog/{logId} {
        allow get, list: if isSignedIn();
        allow create: if isSignedIn() && isOwner(request.resource.data.ownerId);
        allow update, delete: if isSignedIn() && isOwner(resource.data.ownerId);
    }
    
    /**
     * @description Secures the `/subscriptions` collection.
     */
    match /subscriptions/{subscriptionId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && isOwner(request.resource.data.ownerId);
      allow update, delete: if isSignedIn() && isOwner(resource.data.ownerId);
    }

    /**
     * @description Secures the `/invoices` collection.
     */
    match /invoices/{invoiceId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && isOwner(request.resource.data.ownerId);
      allow update, delete: if isSignedIn() && isOwner(resource.data.ownerId);
    }

    /**
     * @description Secures user settings. Users can read and write their own settings document.
     */
    match /userSettings/{userId} {
      allow get, create, update: if request.auth.uid == userId;
      allow list, delete: if false;
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
  }
}
