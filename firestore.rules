rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check ownership
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Rules for all top-level collections
    match /{collection}/{docId} {
      // READ: Users can read their own documents.
      allow get: if isOwner(resource.data.ownerId);

      // LIST: Users can only query for their own documents.
      // The client-side query MUST include `where('ownerId', '==', request.auth.uid)`.
      allow list: if isOwner(request.query.filters.ownerId);

      // CREATE: Users can create documents, but must set themselves as the owner.
      allow create: if isOwner(request.resource.data.ownerId);

      // UPDATE, DELETE: Users can update or delete their own documents.
      allow update, delete: if isOwner(resource.data.ownerId);
    }
  }
}
