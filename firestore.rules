/**
 * @file Firestore Security Rules
 * @version 2
 *
 * @description
 * This ruleset enforces a strict user-ownership model, allowing users to
 * manage only the data they own. All data is stored in top-level collections,
 * with access controlled by the `ownerId` field within each document.
 *
 * Data Structure:
 * - /properties/{propertyId}: Stores property information, accessible only to the property owner.
 * - /revenue/{transactionId}: Stores revenue transaction data, accessible only to the transaction owner.
 * - /expenses/{transactionId}: Stores expense transaction data, accessible only to the transaction owner.
 * - /maintenanceRequests/{requestId}: Stores maintenance requests, accessible only to the request owner.
 * - /changelog/{logId}: Stores activity log entries, accessible only to the log entry owner.
 *
 * Key Security Decisions:
 * - User listing is disallowed for all collections to prevent information leakage.
 * - All write operations are strictly validated against the `ownerId` field
 *   to ensure data consistency and prevent unauthorized modifications.
 * - The rules do NOT validate data types or required fields other than `ownerId`.
 *
 * Denormalization for Authorization:
 * - Each document includes an `ownerId` field. This design decision avoids
 *   expensive `get()` calls to determine ownership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to property documents.
     * @path /properties/{propertyId}
     * @allow (create) User 'user_abc' can create a property document if `request.auth.uid` matches `request.resource.data.ownerId`.
     * @allow (get) Any user can read a property document.
     * @allow (update) User 'user_abc' can update a property document if they are the owner.
     * @allow (delete) User 'user_abc' can delete a property document if they are the owner.
     * @deny (create) User 'user_xyz' cannot create a property document if `request.auth.uid` does not match `request.resource.data.ownerId`.
     * @deny (update) User 'user_xyz' cannot update a property document if they are not the owner.
     * @deny (delete) User 'user_xyz' cannot delete a property document if they are not the owner.
     * @deny (list) Listing properties is not allowed.
     * @principle Enforces document ownership for writes.
     */
    match /properties/{propertyId} {
      // Helpers
      function isOwner(ownerId) {
        return request.auth.uid == ownerId;
      }
      function isExistingOwner(ownerId) {
        return isOwner(ownerId) && resource != null;
      }

      // Reads
      allow get: if true;
      allow list: if false;

      // Writes
      allow create: if isOwner(request.resource.data.ownerId);
      allow update: if isExistingOwner(resource.data.ownerId) && request.resource.data.ownerId == resource.data.ownerId;
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Controls access to revenue transaction documents.
     * @path /revenue/{transactionId}
     * @allow (create) User 'user_abc' can create a revenue transaction document if `request.auth.uid` matches `request.resource.data.ownerId`.
     * @allow (get) Any user can read a revenue transaction document.
     * @allow (update) User 'user_abc' can update a revenue transaction document if they are the owner.
     * @allow (delete) User 'user_abc' can delete a revenue transaction document if they are the owner.
     * @deny (create) User 'user_xyz' cannot create a revenue transaction document if `request.auth.uid` does not match `request.resource.data.ownerId`.
     * @deny (update) User 'user_xyz' cannot update a revenue transaction document if they are not the owner.
     * @deny (delete) User 'user_xyz' cannot delete a revenue transaction document if they are not the owner.
     * @deny (list) Listing revenue transactions is not allowed.
     * @principle Enforces document ownership for writes.
     */
    match /revenue/{transactionId} {
      // Helpers
      function isOwner(ownerId) {
        return request.auth.uid == ownerId;
      }
      function isExistingOwner(ownerId) {
        return isOwner(ownerId) && resource != null;
      }

      // Reads
      allow get: if true;
      allow list: if false;

      // Writes
      allow create: if isOwner(request.resource.data.ownerId);
      allow update: if isExistingOwner(resource.data.ownerId) && request.resource.data.ownerId == resource.data.ownerId;
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Controls access to expense transaction documents.
     * @path /expenses/{transactionId}
     * @allow (create) User 'user_abc' can create an expense transaction document if `request.auth.uid` matches `request.resource.data.ownerId`.
     * @allow (get) Any user can read an expense transaction document.
     * @allow (update) User 'user_abc' can update an expense transaction document if they are the owner.
     * @allow (delete) User 'user_abc' can delete an expense transaction document if they are the owner.
     * @deny (create) User 'user_xyz' cannot create an expense transaction document if `request.auth.uid` does not match `request.resource.data.ownerId`.
     * @deny (update) User 'user_xyz' cannot update an expense transaction document if they are not the owner.
     * @deny (delete) User 'user_xyz' cannot delete an expense transaction document if they are not the owner.
     * @deny (list) Listing expense transactions is not allowed.
     * @principle Enforces document ownership for writes.
     */
    match /expenses/{transactionId} {
      // Helpers
      function isOwner(ownerId) {
        return request.auth.uid == ownerId;
      }
      function isExistingOwner(ownerId) {
        return isOwner(ownerId) && resource != null;
      }

      // Reads
      allow get: if true;
      allow list: if false;

      // Writes
      allow create: if isOwner(request.resource.data.ownerId);
      allow update: if isExistingOwner(resource.data.ownerId) && request.resource.data.ownerId == resource.data.ownerId;
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Controls access to maintenance request documents.
     * @path /maintenanceRequests/{requestId}
     * @allow (create) User 'user_abc' can create a maintenance request document if `request.auth.uid` matches `request.resource.data.ownerId`.
     * @allow (get) Any user can read a maintenance request document.
     * @allow (update) User 'user_abc' can update a maintenance request document if they are the owner.
     * @allow (delete) User 'user_abc' can delete a maintenance request document if they are the owner.
     * @deny (create) User 'user_xyz' cannot create a maintenance request document if `request.auth.uid` does not match `request.resource.data.ownerId`.
     * @deny (update) User 'user_xyz' cannot update a maintenance request document if they are not the owner.
     * @deny (delete) User 'user_xyz' cannot delete a maintenance request document if they are not the owner.
     * @deny (list) Listing maintenance requests is not allowed.
     * @principle Enforces document ownership for writes.
     */
    match /maintenanceRequests/{requestId} {
      // Helpers
      function isOwner(ownerId) {
        return request.auth.uid == ownerId;
      }
      function isExistingOwner(ownerId) {
        return isOwner(ownerId) && resource != null;
      }

      // Reads
      allow get: if true;
      allow list: if false;

      // Writes
      allow create: if isOwner(request.resource.data.ownerId);
      allow update: if isExistingOwner(resource.data.ownerId) && request.resource.data.ownerId == resource.data.ownerId;
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Controls access to changelog entry documents.
     * @path /changelog/{logId}
     * @allow (create) User 'user_abc' can create a changelog entry document if `request.auth.uid` matches `request.resource.data.ownerId`.
     * @allow (get) Any user can read a changelog entry document.
     * @allow (update) User 'user_abc' can update a changelog entry document if they are the owner.
     * @allow (delete) User 'user_abc' can delete a changelog entry document if they are the owner.
     * @deny (create) User 'user_xyz' cannot create a changelog entry document if `request.auth.uid` does not match `request.resource.data.ownerId`.
     * @deny (update) User 'user_xyz' cannot update a changelog entry document if they are not the owner.
     * @deny (delete) User 'user_xyz' cannot delete a changelog entry document if they are not the owner.
     * @deny (list) Listing changelog entries is not allowed.
     * @principle Enforces document ownership for writes.
     */
    match /changelog/{logId} {
      // Helpers
      function isOwner(ownerId) {
        return request.auth.uid == ownerId;
      }
      function isExistingOwner(ownerId) {
        return isOwner(ownerId) && resource != null;
      }

      // Reads
      allow get: if true;
      allow list: if false;

      // Writes
      allow create: if isOwner(request.resource.data.ownerId);
      allow update: if isExistingOwner(resource.data.ownerId) && request.resource.data.ownerId == resource.data.ownerId;
      allow delete: if isExistingOwner(resource.data.ownerId);
    }
  }
}