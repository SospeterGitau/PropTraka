/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for all data.
 *
 * Data Structure:
 * - All documents are stored in top-level collections such as /properties, /revenue, /expenses, /maintenanceRequests, and /changelog.
 * - Each document must have an 'ownerId' field that matches the authenticated user's UID.
 *
 * Key Security Decisions:
 * - Users can only access (read, write) documents where the 'ownerId' field matches their UID.
 * - Listing of documents is allowed only if the query includes a where('ownerId','==', user.uid) clause.
 * - Documents cannot be created without a valid 'ownerId' matching the authenticated user.
 * - The 'ownerId' field is immutable after creation.
 *
 * Denormalization for Authorization:
 * - The 'ownerId' field is denormalized directly onto each document to allow for efficient ownership checks without additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {

    // Make changelog public
    match /changelog/{docId} {
        allow read: if true;
        allow write: if false; // or isAdmin(), etc.
    }

    // Catch-all for owned docs
    match /{collection}/{docId} {
      // READS (get + list): allow if the stored doc owner matches the caller
      allow get, list: if request.auth != null
                       && resource.data.ownerId == request.auth.uid;

      // CREATE: require the incoming doc to set ownerId to the caller
      allow create: if request.auth != null
                    && request.resource.data.ownerId == request.auth.uid;

      // UPDATE/DELETE: allow only the owner
      allow update, delete: if request.auth != null
                            && resource.data.ownerId == request.auth.uid;
    }
  }
}