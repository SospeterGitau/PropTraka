/**
 * @fileoverview Firestore Security Rules for Property Portfolio App
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for properties, transactions, and maintenance requests.
 * Users can only read and modify data they own. The changelog collection is publicly readable but
 * only writeable by authorized users (not yet implemented).
 *
 * Data Structure:
 * - /properties/{propertyId}: Stores individual property documents. Each document must have an `ownerId` field.
 * - /revenue/{transactionId}: Stores revenue transactions. Each document must have an `ownerId` field.
 * - /expenses/{transactionId}: Stores expense transactions. Each document must have an `ownerId` field.
 * - /maintenanceRequests/{requestId}: Stores maintenance requests. Each document must have an `ownerId` field.
 * - /changelog/{logId}: Stores activity log entries.
 *
 * Key Security Decisions:
 * - User listing is generally disallowed to protect privacy.
 * - The changelog collection is publicly readable.
 * - Data validation is relaxed in this prototyping phase, focusing on authorization.
 *
 * Denormalization for Authorization:
 * The `ownerId` field is denormalized onto each document to simplify ownership checks. This avoids the need for complex queries or `get()` calls in the rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to property documents.
     * @path /properties/{propertyId}
     * @allow (create) User creates a new property with their `uid` as the `ownerId`.
     * @allow (get, list, update, delete) User with `auth.uid` matching the `ownerId` can read, update, and delete the property.
     * @deny (create) User attempts to create a property with an `ownerId` that doesn't match their `uid`.
     * @deny (update, delete) User attempts to modify or delete a property they don't own.
     * @principle Enforces document ownership for all operations.
     */
    match /properties/{propertyId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(ownerId) {
        return isSignedIn() && request.auth.uid == ownerId;
      }

      function isExistingOwner(ownerId) {
        return isOwner(ownerId) && resource != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.ownerId);
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Controls access to revenue transaction documents.
     * @path /revenue/{transactionId}
     * @allow (create) User creates a new transaction with their `uid` as the `ownerId`.
     * @allow (get, list, update, delete) User with `auth.uid` matching the `ownerId` can read, update, and delete the transaction.
     * @deny (create) User attempts to create a transaction with an `ownerId` that doesn't match their `uid`.
     * @deny (update, delete) User attempts to modify or delete a transaction they don't own.
     * @principle Enforces document ownership for all operations.
     */
    match /revenue/{transactionId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(ownerId) {
        return isSignedIn() && request.auth.uid == ownerId;
      }

      function isExistingOwner(ownerId) {
        return isOwner(ownerId) && resource != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.ownerId);
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Controls access to expense transaction documents.
     * @path /expenses/{transactionId}
     * @allow (create) User creates a new transaction with their `uid` as the `ownerId`.
     * @allow (get, list, update, delete) User with `auth.uid` matching the `ownerId` can read, update, and delete the transaction.
     * @deny (create) User attempts to create a transaction with an `ownerId` that doesn't match their `uid`.
     * @deny (update, delete) User attempts to modify or delete a transaction they don't own.
     * @principle Enforces document ownership for all operations.
     */
    match /expenses/{transactionId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(ownerId) {
        return isSignedIn() && request.auth.uid == ownerId;
      }

      function isExistingOwner(ownerId) {
        return isOwner(ownerId) && resource != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.ownerId);
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Controls access to maintenance request documents.
     * @path /maintenanceRequests/{requestId}
     * @allow (create) User creates a new request with their `uid` as the `ownerId`.
     * @allow (get, list, update, delete) User with `auth.uid` matching the `ownerId` can read, update, and delete the request.
     * @deny (create) User attempts to create a request with an `ownerId` that doesn't match their `uid`.
     * @deny (update, delete) User attempts to modify or delete a request they don't own.
     * @principle Enforces document ownership for all operations.
     */
    match /maintenanceRequests/{requestId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(ownerId) {
        return isSignedIn() && request.auth.uid == ownerId;
      }

      function isExistingOwner(ownerId) {
        return isOwner(ownerId) && resource != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.ownerId);
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Controls access to changelog documents.
     * @path /changelog/{logId}
     * @allow (get, list) Anyone can read the changelog.
     * @deny (create, update, delete) No one can create, update, or delete changelog entries (yet).
     * @principle Allows public read access to the changelog; writes are disabled in this prototype.
     */
    match /changelog/{logId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;  // TODO: Implement admin-only write access.
      allow update: if false;  // TODO: Implement admin-only write access.
      allow delete: if false;  // TODO: Implement admin-only write access.
    }
  }
}