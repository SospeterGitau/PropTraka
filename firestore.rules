/**
 * @fileOverview
 * This ruleset enforces a strict user-ownership model for managing rental property data.
 * All data is nested under /users/{userId}, ensuring that only the authenticated user can access their own data.
 *
 * Data Structure:
 * - /users/{userId}: Root for all user-specific data.
 * - /users/{userId}/properties/{propertyId}: Properties owned by the user.
 * - /users/{userId}/properties/{propertyId}/tenants/{tenantId}: Tenants of a property.
 * - /users/{userId}/properties/{propertyId}/rentalPayments/{rentalPaymentId}: Rental payments for a property.
 * - /users/{userId}/properties/{propertyId}/expenses/{expenseId}: Expenses for a property.
 * - /users/{userId}/properties/{propertyId}/appointments/{appointmentId}: Appointments for a property.
 * - /users/{userId}/properties/{propertyId}/alerts/{alertId}: Alerts for a property.
 * - /users/{userId}/maintenanceRequests/{maintenanceRequestId}: Maintenance requests created by the user.
 *
 * Key Security Decisions:
 * - Strict user-ownership: Users can only access data under their own user ID.
 * - Data Denormalization: Subcollections include a denormalized `ownerId` field (copied from the parent `property` document) to avoid costly `get()` calls in security rules.
 * - Authorization Independence: Rules avoid hierarchical `get()` calls by ensuring that all authorization information is available within the document being accessed.
 * - Data Integrity:  The structure supports data integrity by enforcing clear ownership and relationships.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by a signed-in user.
     * @returns {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     * @param {string} userId The user ID to compare against the authenticated user's ID.
     * @returns {boolean} True if the user IDs match, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the existing document.
     * @param {string} userId The user ID to compare against the authenticated user's ID.
     * @returns {boolean} True if the user is the owner and the document exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for documents in the /users/{userId}/properties/{propertyId} path.
     * @path /users/{userId}/properties/{propertyId}
     * @allow (create) - Authenticated user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can create a property with userId 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @allow (get, list) - Authenticated user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can read their property data.
     * @allow (update, delete) - Authenticated user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can update or delete a property they own.
     * @deny (create) - Authenticated user 'OtherUserID' cannot create a property with userId 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/properties/{propertyId} {
      // Read rules
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      // Write rules
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for documents in the /users/{userId}/properties/{propertyId}/tenants/{tenantId} path.
     * @path /users/{userId}/properties/{propertyId}/tenants/{tenantId}
     * @allow (create) - Authenticated user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can create a tenant under their property.
     * @allow (get, list) - Authenticated user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can read tenants under their property.
     * @allow (update, delete) - Authenticated user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can update or delete tenants under their property.
     * @deny (create) - Authenticated user 'OtherUserID' cannot create a tenant under property owned by 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @principle Enforces document ownership and prevents unauthorized data modification.
     */
    match /users/{userId}/properties/{propertyId}/tenants/{tenantId} {
      // Read rules
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      // Write rules
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for documents in the /users/{userId}/properties/{propertyId}/rentalPayments/{rentalPaymentId} path.
     * @path /users/{userId}/properties/{propertyId}/rentalPayments/{rentalPaymentId}
     * @allow (create) - Authenticated user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can create a rental payment under their property.
     * @allow (get, list) - Authenticated user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can read rental payments under their property.
     * @allow (update, delete) - Authenticated user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can update or delete rental payments under their property.
     * @deny (create) - Authenticated user 'OtherUserID' cannot create a rental payment under property owned by 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @principle Enforces document ownership and prevents unauthorized data modification.
     */
    match /users/{userId}/properties/{propertyId}/rentalPayments/{rentalPaymentId} {
      // Read rules
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      // Write rules
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for documents in the /users/{userId}/properties/{propertyId}/expenses/{expenseId} path.
     * @path /users/{userId}/properties/{propertyId}/expenses/{expenseId}
     * @allow (create) - Authenticated user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can create an expense under their property.
     * @allow (get, list) - Authenticated user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can read expenses under their property.
     * @allow (update, delete) - Authenticated user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can update or delete expenses under their property.
     * @deny (create) - Authenticated user 'OtherUserID' cannot create an expense under property owned by 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @principle Enforces document ownership and prevents unauthorized data modification.
     */
    match /users/{userId}/properties/{propertyId}/expenses/{expenseId} {
      // Read rules
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      // Write rules
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for documents in the /users/{userId}/properties/{propertyId}/appointments/{appointmentId} path.
     * @path /users/{userId}/properties/{propertyId}/appointments/{appointmentId}
     * @allow (create) - Authenticated user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can create an appointment under their property.
     * @allow (get, list) - Authenticated user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can read appointments under their property.
     * @allow (update, delete) - Authenticated user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can update or delete appointments under their property.
     * @deny (create) - Authenticated user 'OtherUserID' cannot create an appointment under property owned by 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @principle Enforces document ownership and prevents unauthorized data modification.
     */
    match /users/{userId}/properties/{propertyId}/appointments/{appointmentId} {
      // Read rules
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      // Write rules
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for documents in the /users/{userId}/properties/{propertyId}/alerts/{alertId} path.
     * @path /users/{userId}/properties/{propertyId}/alerts/{alertId}
     * @allow (create) - Authenticated user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can create an alert under their property.
     * @allow (get, list) - Authenticated user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can read alerts under their property.
     * @allow (update, delete) - Authenticated user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can update or delete alerts under their property.
     * @deny (create) - Authenticated user 'OtherUserID' cannot create an alert under property owned by 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @principle Enforces document ownership and prevents unauthorized data modification.
     */
    match /users/{userId}/properties/{propertyId}/alerts/{alertId} {
      // Read rules
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      // Write rules
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for documents in the /users/{userId}/maintenanceRequests/{maintenanceRequestId} path.
     * @path /users/{userId}/maintenanceRequests/{maintenanceRequestId}
     * @allow (create) - Authenticated user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can create a maintenance request with userId 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @allow (get, list) - Authenticated user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can read their maintenance request data.
     * @allow (update, delete) - Authenticated user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can update or delete a maintenance request they own.
     * @deny (create) - Authenticated user 'OtherUserID' cannot create a maintenance request with userId 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/maintenanceRequests/{maintenanceRequestId} {
      // Read rules
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      // Write rules
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}