rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check ownership
    function isOwner() {
      return request.auth != null && request.auth.uid == resource.data.ownerId;
    }

    // Function to check if a query is correctly filtered by owner
    function isQueryingOwnData() {
      return request.auth != null && request.query.filters.size() == 1 && 'ownerId' in request.query.filters && request.query.filters.ownerId == request.auth.uid;
    }

    // Secure all top-level collections with the same ownership-based rules.
    match /{collection}/{docId} {
      // READ, UPDATE, DELETE on a single document: User must be the owner.
      allow get, update, delete: if isOwner();

      // CREATE a new document: The new document's ownerId must be the user's own UID.
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
      
      // LIST (query) the collection: The query must be filtered by the user's UID.
      allow list: if isQueryingOwnData();
    }
  }
}
