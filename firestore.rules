
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check ownership
    function isOwner(docData) {
      return request.auth.uid == docData.ownerId;
    }

    // Secure all collections with the same ownership-based rules
    match /{collection}/{docId} {
      // Allow individual document reads/writes if the user is the owner
      allow read, write: if request.auth != null && isOwner(resource.data);

      // Allow list (query) operations ONLY if the query is filtered by the user's own ownerId
      allow list: if request.auth != null && request.query.get("where")[0][1] == "ownerId" && request.query.get("where")[0][2] == request.auth.uid;
    }
  }
}
