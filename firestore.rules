/**
 * @fileoverview Firestore Security Rules for the property management application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for all data entities: properties, transactions (revenue & expenses), maintenance requests, and changelog entries.
 * Only the owner (identified by `ownerId`) can create, read, update, or delete documents.
 *
 * Data Structure:
 * Data is stored in top-level collections: `/properties/{propertyId}`, `/revenue/{transactionId}`, `/expenses/{transactionId}`, `/maintenanceRequests/{requestId}`, and `/changelog/{logId}`.
 * Each document within these collections is expected to have an `ownerId` field indicating the owning user.
 *
 * Key Security Decisions:
 * - All write operations are strictly limited to the document owner, preventing unauthorized data modification or deletion.
 * - Read operations are restricted to the document owner.
 * - All collections are secured using the ownership pattern.
 *
 * Denormalization for Authorization:
 * The `ownerId` field is used to make authorization decisions. This field *MUST* exist on every document in the collections listed above.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to property documents.
     * @path /properties/{propertyId}
     * @allow (create) - Allows a user to create a property if the ownerId in the request matches their auth UID.
     * @allow (get, list) - Allows a user to read a property if the ownerId in the document matches their auth UID.
     * @allow (update, delete) - Allows a user to update/delete a property if the ownerId in the document matches their auth UID.
     * @deny (create) - Denies a user from creating a property if the ownerId in the request does not match their auth UID.
     * @deny (get, list) - Denies a user from reading a property if the ownerId in the document does not match their auth UID.
     * @deny (update, delete) - Denies a user from updating/deleting a property if the ownerId in the document does not match their auth UID.
     * @principle Enforces document ownership for all operations.
     */
    match /properties/{propertyId} {
      allow get, list: if isSignedIn() && resource.data.ownerId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.ownerId == request.auth.uid;
    }

    /**
     * @description Controls access to revenue transaction documents.
     * @path /revenue/{transactionId}
     * @allow (create) - Allows a user to create a revenue transaction if the ownerId in the request matches their auth UID.
     * @allow (get, list) - Allows a user to read a revenue transaction if the ownerId in the document matches their auth UID.
     * @allow (update, delete) - Allows a user to update/delete a revenue transaction if the ownerId in the document matches their auth UID.
     * @deny (create) - Denies a user from creating a revenue transaction if the ownerId in the request does not match their auth UID.
     * @deny (get, list) - Denies a user from reading a revenue transaction if the ownerId in the document does not match their auth UID.
     * @deny (update, delete) - Denies a user from updating/deleting a revenue transaction if the ownerId in the document does not match their auth UID.
     * @principle Enforces document ownership for all operations.
     */
    match /revenue/{transactionId} {
      allow get, list: if isSignedIn() && resource.data.ownerId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.ownerId == request.auth.uid;
    }

    /**
     * @description Controls access to expense transaction documents.
     * @path /expenses/{transactionId}
     * @allow (create) - Allows a user to create an expense transaction if the ownerId in the request matches their auth UID.
     * @allow (get, list) - Allows a user to read an expense transaction if the ownerId in the document matches their auth UID.
     * @allow (update, delete) - Allows a user to update/delete an expense transaction if the ownerId in the document matches their auth UID.
     * @deny (create) - Denies a user from creating an expense transaction if the ownerId in the request does not match their auth UID.
     * @deny (get, list) - Denies a user from reading an expense transaction if the ownerId in the document does not match their auth UID.
     * @deny (update, delete) - Denies a user from updating/deleting an expense transaction if the ownerId in the document does not match their auth UID.
     * @principle Enforces document ownership for all operations.
     */
    match /expenses/{transactionId} {
      allow get, list: if isSignedIn() && resource.data.ownerId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.ownerId == request.auth.uid;
    }

    /**
     * @description Controls access to maintenance request documents.
     * @path /maintenanceRequests/{requestId}
     * @allow (create) - Allows a user to create a maintenance request if the ownerId in the request matches their auth UID.
     * @allow (get, list) - Allows a user to read a maintenance request if the ownerId in the document matches their auth UID.
     * @allow (update, delete) - Allows a user to update/delete a maintenance request if the ownerId in the document matches their auth UID.
     * @deny (create) - Denies a user from creating a maintenance request if the ownerId in the request does not match their auth UID.
     * @deny (get, list) - Denies a user from reading a maintenance request if the ownerId in the document does not match their auth UID.
     * @deny (update, delete) - Denies a user from updating/deleting a maintenance request if the ownerId in the document does not match their auth UID.
     * @principle Enforces document ownership for all operations.
     */
    match /maintenanceRequests/{requestId} {
      allow get, list: if isSignedIn() && resource.data.ownerId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.ownerId == request.auth.uid;
    }

    /**
     * @description Controls access to changelog entry documents.
     * @path /changelog/{logId}
     * @allow (create) - Allows a user to create a changelog entry if the ownerId in the request matches their auth UID.
     * @allow (get, list) - Allows a user to read a changelog entry if the ownerId in the document matches their auth UID.
     * @allow (update, delete) - Allows a user to update/delete a changelog entry if the ownerId in the document matches their auth UID.
     * @deny (create) - Denies a user from creating a changelog entry if the ownerId in the request does not match their auth UID.
     * @deny (get, list) - Denies a user from reading a changelog entry if the ownerId in the document does not match their auth UID.
     * @deny (update, delete) - Denies a user from updating/deleting a changelog entry if the ownerId in the document does not match their auth UID.
     * @principle Enforces document ownership for all operations.
     */
    match /changelog/{logId} {
      allow get, list: if isSignedIn() && resource.data.ownerId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.ownerId == request.auth.uid;
    }
  }
}

function isSignedIn() {
  return request.auth != null;
}