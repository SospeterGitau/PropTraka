/**
 * @fileoverview Firestore Security Rules for the property management application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for all data. Each document
 * (property, transaction, maintenance request, changelog entry) is owned by a specific user,
 * and only that user has write access. Read access is generally restricted to the owner, except
 * for `properties`, which are publicly readable to support the core listing functionality but only updatable by the owner.
 *
 * Data Structure:
 * The Firestore database is structured as a flat collection of documents:
 * - /properties/{propertyId}
 * - /revenue/{transactionId}
 * - /expenses/{transactionId}
 * - /maintenanceRequests/{requestId}
 * - /changelog/{logId}
 *
 * Key Security Decisions:
 * - **User Listing is Disallowed:** There is no user collection, so user listing is impossible.
 * - **Owner-Only Access:** By default, all write operations are restricted to the owner of the
 *   specific document, and all operations enforce that the `ownerId` field within the document
 *   matches the authenticated user's UID.
 * - **Publicly Readable Properties:** The `properties` collection is configured to be publicly readable (`get`, `list`) to allow anonymous users to view property data, but only the owner can modify a property.
 *
 * Denormalization for Authorization:
 * All documents (properties, transactions, maintenance requests, changelog entries) must contain an `ownerId` field that matches the authenticated user's UID for write operations. This denormalization avoids the need for complex `get()` calls and ensures efficient authorization.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows anyone to read property data, but only the owner can create, update, or delete a property.
     * @path /properties/{propertyId}
     * @allow (get, list)
     * @allow (create) if request.auth.uid matches the ownerId in the incoming data.
     * @allow (update, delete) if request.auth.uid matches the ownerId in the existing document.
     * @deny (create) if request.auth.uid does not match the ownerId in the incoming data.
     * @deny (update, delete) if request.auth.uid does not match the ownerId in the existing document.
     * @principle Allows public read access to property listings while restricting write access to the owner.
     */
    match /properties/{propertyId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isSignedIn() && isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Only the owner can create, read, update, or delete a revenue transaction.
     * @path /revenue/{transactionId}
     * @allow (create) if request.auth.uid matches the ownerId in the incoming data.
     * @allow (get, list) if request.auth.uid matches the ownerId in the existing document.
     * @allow (update, delete) if request.auth.uid matches the ownerId in the existing document.
     * @deny (create) if request.auth.uid does not match the ownerId in the incoming data.
     * @deny (get, list) if request.auth.uid does not match the ownerId in the existing document.
     * @deny (update, delete) if request.auth.uid does not match the ownerId in the existing document.
     * @principle Enforces document ownership for all operations on revenue transactions.
     */
    match /revenue/{transactionId} {
      allow get, list: if isSignedIn() && isOwner(resource.data.ownerId);
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isSignedIn() && isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Only the owner can create, read, update, or delete an expense transaction.
     * @path /expenses/{transactionId}
     * @allow (create) if request.auth.uid matches the ownerId in the incoming data.
     * @allow (get, list) if request.auth.uid matches the ownerId in the existing document.
     * @allow (update, delete) if request.auth.uid matches the ownerId in the existing document.
     * @deny (create) if request.auth.uid does not match the ownerId in the incoming data.
     * @deny (get, list) if request.auth.uid does not match the ownerId in the existing document.
     * @deny (update, delete) if request.auth.uid does not match the ownerId in the existing document.
     * @principle Enforces document ownership for all operations on expense transactions.
     */
    match /expenses/{transactionId} {
      allow get, list: if isSignedIn() && isOwner(resource.data.ownerId);
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isSignedIn() && isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Only the owner can create, read, update, or delete a maintenance request.
     * @path /maintenanceRequests/{requestId}
     * @allow (create) if request.auth.uid matches the ownerId in the incoming data.
     * @allow (get, list) if request.auth.uid matches the ownerId in the existing document.
     * @allow (update, delete) if request.auth.uid matches the ownerId in the existing document.
     * @deny (create) if request.auth.uid does not match the ownerId in the incoming data.
     * @deny (get, list) if request.auth.uid does not match the ownerId in the existing document.
     * @deny (update, delete) if request.auth.uid does not match the ownerId in the existing document.
     * @principle Enforces document ownership for all operations on maintenance requests.
     */
    match /maintenanceRequests/{requestId} {
      allow get, list: if isSignedIn() && isOwner(resource.data.ownerId);
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isSignedIn() && isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Only the owner can create, read, update, or delete a changelog entry.
     * @path /changelog/{logId}
     * @allow (create) if request.auth.uid matches the ownerId in the incoming data.
     * @allow (get, list) if request.auth.uid matches the ownerId in the existing document.
     * @allow (update, delete) if request.auth.uid matches the ownerId in the existing document.
     * @deny (create) if request.auth.uid does not match the ownerId in the incoming data.
     * @deny (get, list) if request.auth.uid does not match the ownerId in the existing document.
     * @deny (update, delete) if request.auth.uid does not match the ownerId in the existing document.
     * @principle Enforces document ownership for all operations on changelog entries.
     */
    match /changelog/{logId} {
      allow get, list: if isSignedIn() && isOwner(resource.data.ownerId);
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isSignedIn() && isExistingOwner(resource.data.ownerId);
    }
  }

  // Helper function to determine if the user is signed in.
  function isSignedIn() {
    return request.auth != null;
  }

  // Helper function to determine if the user is the owner of the resource.
  function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
  }

  // Helper function to determine if the user is the owner of the resource and it exists.
  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}