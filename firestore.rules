/**
 * @fileoverview Firestore Security Rules for Property Portfolio App
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model, ensuring that only the owner of a resource can create, read, update, or delete it.
 *
 * Data Structure:
 * - Properties, transactions (revenue/expenses), maintenance requests, and changelog entries are stored in top-level collections.
 * - All documents contain an `ownerId` field that MUST match the authenticated user's UID.
 *
 * Key Security Decisions:
 * - Listing of changelog entries is denied to all users.
 * - Schema validation is relaxed in favor of rapid prototyping, focusing only on ownership and relational integrity checks.
 *
 * Denormalization for Authorization:
 * - Each document includes an `ownerId` field, enabling simple ownership checks without additional `get()` calls.
 *
 * Structural Segregation:
 * - Private user data is stored in top-level collections, enforcing clear ownership and preventing accidental public exposure.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to property documents. Only the owner can create, read, update, or delete properties.
     * @path /properties/{propertyId}
     * @allow (create) User with UID 'test_user' can create a property document if request.auth.uid == request.resource.data.ownerId.
     * @allow (get) Any user can read a property document if the document exists.
     * @allow (list) Any user can list property documents if the document exists.
     * @allow (update) User with UID 'test_user' can update a property document if they are the owner (resource.data.ownerId == 'test_user').
     * @allow (delete) User with UID 'test_user' can delete a property document if they are the owner (resource.data.ownerId == 'test_user').
     * @deny (create) User with UID 'malicious_user' cannot create a property document if request.auth.uid != request.resource.data.ownerId.
     * @deny (update) User with UID 'attacker' cannot update a property document if they are not the owner (resource.data.ownerId != 'attacker').
     * @deny (delete) User with UID 'hacker' cannot delete a property document if they are not the owner (resource.data.ownerId != 'hacker').
     * @principle Enforces document ownership for writes.
     */
    match /properties/{propertyId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.ownerId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Controls access to revenue transaction documents. Only the owner can create, read, update, or delete revenue transactions.
     * @path /revenue/{transactionId}
     * @allow (create) User with UID 'test_user' can create a revenue transaction document if request.auth.uid == request.resource.data.ownerId.
     * @allow (get) Any user can read a revenue transaction document if the document exists.
     * @allow (list) Any user can list revenue transaction documents if the document exists.
     * @allow (update) User with UID 'test_user' can update a revenue transaction document if they are the owner (resource.data.ownerId == 'test_user').
     * @allow (delete) User with UID 'test_user' can delete a revenue transaction document if they are the owner (resource.data.ownerId == 'test_user').
     * @deny (create) User with UID 'malicious_user' cannot create a revenue transaction document if request.auth.uid != request.resource.data.ownerId.
     * @deny (update) User with UID 'attacker' cannot update a revenue transaction document if they are not the owner (resource.data.ownerId != 'attacker').
     * @deny (delete) User with UID 'hacker' cannot delete a revenue transaction document if they are not the owner (resource.data.ownerId != 'hacker').
     * @principle Enforces document ownership for writes.
     */
    match /revenue/{transactionId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.ownerId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.ownerId);
    }

        /**
     * @description Controls access to expense transaction documents. Only the owner can create, read, update, or delete expense transactions.
     * @path /expenses/{transactionId}
     * @allow (create) User with UID 'test_user' can create an expense transaction document if request.auth.uid == request.resource.data.ownerId.
     * @allow (get) Any user can read an expense transaction document if the document exists.
     * @allow (list) Any user can list expense transaction documents if the document exists.
     * @allow (update) User with UID 'test_user' can update an expense transaction document if they are the owner (resource.data.ownerId == 'test_user').
     * @allow (delete) User with UID 'test_user' can delete an expense transaction document if they are the owner (resource.data.ownerId == 'test_user').
     * @deny (create) User with UID 'malicious_user' cannot create an expense transaction document if request.auth.uid != request.resource.data.ownerId.
     * @deny (update) User with UID 'attacker' cannot update an expense transaction document if they are not the owner (resource.data.ownerId != 'attacker').
     * @deny (delete) User with UID 'hacker' cannot delete an expense transaction document if they are not the owner (resource.data.ownerId != 'hacker').
     * @principle Enforces document ownership for writes.
     */
    match /expenses/{transactionId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.ownerId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Controls access to maintenance request documents. Only the owner can create, read, update, or delete maintenance requests.
     * @path /maintenanceRequests/{requestId}
     * @allow (create) User with UID 'test_user' can create a maintenance request document if request.auth.uid == request.resource.data.ownerId.
     * @allow (get) Any user can read a maintenance request document if the document exists.
     * @allow (list) Any user can list maintenance request documents if the document exists.
     * @allow (update) User with UID 'test_user' can update a maintenance request document if they are the owner (resource.data.ownerId == 'test_user').
     * @allow (delete) User with UID 'test_user' can delete a maintenance request document if they are the owner (resource.data.ownerId == 'test_user').
     * @deny (create) User with UID 'malicious_user' cannot create a maintenance request document if request.auth.uid != request.resource.data.ownerId.
     * @deny (update) User with UID 'attacker' cannot update a maintenance request document if they are not the owner (resource.data.ownerId != 'attacker').
     * @deny (delete) User with UID 'hacker' cannot delete a maintenance request document if they are not the owner (resource.data.ownerId != 'hacker').
     * @principle Enforces document ownership for writes.
     */
    match /maintenanceRequests/{requestId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.ownerId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.ownerId);
    }

        /**
     * @description Controls access to change log entry documents. Only the owner can create, read, update, or delete change log entries. Listing is denied to all users.
     * @path /changelog/{logId}
     * @allow (create) User with UID 'test_user' can create a change log entry document if request.auth.uid == request.resource.data.ownerId.
     * @allow (get) Any user can read a change log entry document if the document exists.
     * @deny (list) No user can list change log entry documents.
     * @allow (update) User with UID 'test_user' can update a change log entry document if they are the owner (resource.data.ownerId == 'test_user').
     * @allow (delete) User with UID 'test_user' can delete a change log entry document if they are the owner (resource.data.ownerId == 'test_user').
     * @deny (create) User with UID 'malicious_user' cannot create a change log entry document if request.auth.uid != request.resource.data.ownerId.
     * @deny (update) User with UID 'attacker' cannot update a change log entry document if they are not the owner (resource.data.ownerId != 'attacker').
     * @deny (delete) User with UID 'hacker' cannot delete a change log entry document if they are not the owner (resource.data.ownerId != 'hacker').
     * @principle Enforces document ownership for writes and restricts listing.
     */
    match /changelog/{logId} {
      allow get: if true;
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.ownerId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.ownerId);
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
        return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
  }
}