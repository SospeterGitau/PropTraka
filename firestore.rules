rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     * @returns {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     * @param {string} userId - The user ID to compare against.
     * @returns {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the existing document.
     * @param {string} userId - The user ID to compare against.
     * @returns {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource.data.ownerId == request.auth.uid;
    }
    
    /**
     * @description Grants access to a user's profile document.
     * @path /users/{userId}
     * @allow (create) - Authenticated user creates their own profile with matching UID.
     * @deny (create) - Unauthenticated user attempts to create a profile.
     * @deny (create) - Authenticated user attempts to create a profile with a mismatched UID.
     * @allow (get, list) - Authenticated user reads their own profile.
     * @deny (get, list) - Unauthenticated user attempts to read a profile.
     * @deny (update, delete) - Only the authenticated user can update/delete their own profile.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Grants access to properties owned by a specific user.
     * @path /users/{userId}/properties/{propertyId}
     * @allow (create) - Authenticated user creates a property under their own user ID.
     * @deny (create) - Unauthenticated user attempts to create a property.
     * @deny (create) - Authenticated user attempts to create a property under a different user ID.
     * @allow (get, list) - Authenticated user reads properties under their own user ID.
     * @deny (get, list) - Unauthenticated user attempts to read properties.
     * @deny (update, delete) - Only the authenticated user can update/delete their own properties.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Grants access to tenants related to a specific property, owned by a user.
     * @path /users/{userId}/properties/{propertyId}/tenants/{tenantId}
     * @allow (create) - Authenticated user creates a tenant under their own user ID and property.
     * @deny (create) - Unauthenticated user attempts to create a tenant.
     * @deny (create) - Authenticated user attempts to create a tenant under a different user ID or property.
     * @allow (get, list) - Authenticated user reads tenants under their own user ID and property.
     * @deny (get, list) - Unauthenticated user attempts to read tenants.
     * @deny (update, delete) - Only the authenticated user can update/delete tenants under their own user ID and property.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId}/tenants/{tenantId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Grants access to rental payments made for a specific property, owned by a user.
     * @path /users/{userId}/properties/{propertyId}/rentalPayments/{rentalPaymentId}
     * @allow (create) - Authenticated user creates a rental payment under their own user ID and property.
     * @deny (create) - Unauthenticated user attempts to create a rental payment.
     * @deny (create) - Authenticated user attempts to create a rental payment under a different user ID or property.
     * @allow (get, list) - Authenticated user reads rental payments under their own user ID and property.
     * @deny (get, list) - Unauthenticated user attempts to read rental payments.
     * @deny (update, delete) - Only the authenticated user can update/delete rental payments under their own user ID and property.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId}/rentalPayments/{rentalPaymentId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Grants access to expenses related to a specific property, owned by a user.
     * @path /users/{userId}/properties/{propertyId}/expenses/{expenseId}
     * @allow (create) - Authenticated user creates an expense under their own user ID and property.
     * @deny (create) - Unauthenticated user attempts to create an expense.
     * @deny (create) - Authenticated user attempts to create an expense under a different user ID or property.
     * @allow (get, list) - Authenticated user reads expenses under their own user ID and property.
     * @deny (get, list) - Unauthenticated user attempts to read expenses.
     * @deny (update, delete) - Only the authenticated user can update/delete expenses under their own user ID and property.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId}/expenses/{expenseId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Grants access to appointments related to a specific property, owned by a user.
     * @path /users/{userId}/properties/{propertyId}/appointments/{appointmentId}
     * @allow (create) - Authenticated user creates an appointment under their own user ID and property.
     * @deny (create) - Unauthenticated user attempts to create an appointment.
     * @deny (create) - Authenticated user attempts to create an appointment under a different user ID or property.
     * @allow (get, list) - Authenticated user reads appointments under their own user ID and property.
     * @deny (get, list) - Unauthenticated user attempts to read appointments.
     * @deny (update, delete) - Only the authenticated user can update/delete appointments under their own user ID and property.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId}/appointments/{appointmentId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Grants access to alerts related to a specific property, owned by a user.
     * @path /users/{userId}/properties/{propertyId}/alerts/{alertId}
     * @allow (create) - Authenticated user creates an alert under their own user ID and property.
     * @deny (create) - Unauthenticated user attempts to create an alert.
     * @deny (create) - Authenticated user attempts to create an alert under a different user ID or property.
     * @allow (get, list) - Authenticated user reads alerts under their own user ID and property.
     * @deny (get, list) - Unauthenticated user attempts to read alerts.
     * @deny (update, delete) - Only the authenticated user can update/delete alerts under their own user ID and property.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId}/alerts/{alertId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Grants access to maintenance requests for properties owned by a specific user.
     * @path /users/{userId}/maintenanceRequests/{maintenanceRequestId}
     * @allow (create) - Authenticated user creates a maintenance request under their own user ID.
     * @deny (create) - Unauthenticated user attempts to create a maintenance request.
     * @deny (create) - Authenticated user attempts to create a maintenance request under a different user ID.
     * @allow (get, list) - Authenticated user reads maintenance requests under their own user ID.
     * @deny (get, list) - Unauthenticated user attempts to read maintenance requests.
     * @deny (update, delete) - Only the authenticated user can update/delete their own maintenance requests.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/maintenanceRequests/{maintenanceRequestId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Fixes the reported error by granting list access to the changelog subcollection.
     * @path /users/{userId}/changelog
     * @allow (list) - Authenticated user reads changelog under their own user ID.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/changelog/{documentId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}