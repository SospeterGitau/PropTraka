rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isSignedIn() && request.auth.uid == resource.data.userId;
    }

    /**
     * @description Allows a user to manage their own properties.
     * @path /users/{userId}/properties/{propertyId}
     * @allow (create) - User 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can create a property with the correct userId in the path and matching the document.
     * @allow (get, list, update, delete) - User 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can read, update, and delete their own property data.
     * @deny (create) - User 'randomID' cannot create a property for user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId && request.resource.data.userId == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows a user to manage tenants for their properties.
     * @path /users/{userId}/properties/{propertyId}/tenants/{tenantId}
     * @allow (create) - User 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can create a tenant for their property.
     * @allow (get, list, update, delete) - User 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can read, update, and delete tenants for their property.
     * @deny (create) - User 'randomID' cannot create a tenant for user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId}/tenants/{tenantId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows a user to manage rental payments for their properties.
     * @path /users/{userId}/properties/{propertyId}/rentalPayments/{rentalPaymentId}
     * @allow (create) - User 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can create a rental payment for their property.
     * @allow (get, list, update, delete) - User 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can read, update, and delete rental payments for their property.
     * @deny (create) - User 'randomID' cannot create a rental payment for user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId}/rentalPayments/{rentalPaymentId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows a user to manage expenses for their properties.
     * @path /users/{userId}/properties/{propertyId}/expenses/{expenseId}
     * @allow (create) - User 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can create an expense for their property.
     * @allow (get, list, update, delete) - User 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can read, update, and delete expenses for their property.
     * @deny (create) - User 'randomID' cannot create an expense for user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId}/expenses/{expenseId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows a user to manage appointments for their properties.
     * @path /users/{userId}/properties/{propertyId}/appointments/{appointmentId}
     * @allow (create) - User 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can create an appointment for their property.
     * @allow (get, list, update, delete) - User 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can read, update, and delete appointments for their property.
     * @deny (create) - User 'randomID' cannot create an appointment for user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId}/appointments/{appointmentId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows a user to manage alerts for their properties.
     * @path /users/{userId}/properties/{propertyId}/alerts/{alertId}
     * @allow (create) - User 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can create an alert for their property.
     * @allow (get, list, update, delete) - User 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can read, update, and delete alerts for their property.
     * @deny (create) - User 'randomID' cannot create an alert for user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId}/alerts/{alertId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows a user to manage maintenance requests for their properties.
     * @path /users/{userId}/maintenanceRequests/{maintenanceRequestId}
     * @allow (create) - User 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can create a maintenance request.
     * @allow (get, list, update, delete) - User 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can read, update, and delete their own maintenance requests.
     * @deny (create) - User 'randomID' cannot create a maintenance request for user 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/maintenanceRequests/{maintenanceRequestId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Prevents listing of the /revenue collection.  This collection's purpose is unclear.
     * @path /revenue
     * @deny (list) - No one can list the revenue collection.
     * @principle Denies listing of the revenue collection.
     */
    match /revenue {
        allow get: if false;
        allow list: if false;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }
  }
}