/**
 * @fileoverview Firestore Security Rules for the rental property management application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Each user has full control over their own data,
 * and no user can access another user's data. All data is nested under /users/{userId} to enforce
 * this ownership. Subcollections under /properties/{propertyId} inherit ownership from the parent
 * property document.
 *
 * Data Structure:
 * All data is nested under /users/{userId}.  Each user has a collection of properties, and each property
 * has subcollections for tenants, rental payments, expenses, appointments, and alerts.
 * Maintenance Requests are directly under the /users/{userId} collection.
 *
 * Key Security Decisions:
 * - Users can only access their own data.
 * - Listing all users is disallowed.
 * - Data in user subcollections implicitly inherits ownership from the parent property document,
 *   avoiding the need for complex `get()` calls in the rules.
 * - Denormalization is used to simplify and optimize rules. The `ownerId` is copied to all subcollections
 *   of a property to avoid hierarchical `get()` calls.
 *
 * Authorization Independence:
 * All subcollections under a property include a denormalized `ownerId` field, copied from the parent
 * property. This eliminates the need for `get()` calls in security rules, ensuring atomic operations
 * and easy debugging.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     * @example isSignedIn() == true if request.auth != null
     * @principle Requires authentication for data access.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the current user is the owner of the resource based on the userId.
     * @param {string} userId - The user ID to compare against the request's auth UID.
     * @example isOwner("user123") == (request.auth.uid == "user123")
     * @principle Enforces ownership-based access control.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the current user is the owner of the resource, and that the document exists.
     * @param {string} userId - The user ID to compare against the request's auth UID.
     * @example isExistingOwner("user123") == (request.auth.uid == "user123" && resource != null)
     * @principle Enforces ownership-based access control and prevents modification of non-existent documents.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for user properties.
     * @path /users/{userId}/properties/{propertyId}
     * @allow (create) - Authenticated user with matching userId can create a property.
     * @allow (get, list, update, delete) - Authenticated user with matching userId can read, update, or delete a property.
     * @deny (create) - Authenticated user with non-matching userId cannot create a property.
     * @deny (update, delete) - Authenticated user with non-matching userId cannot update or delete a property.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for tenants associated with a property.
     * @path /users/{userId}/properties/{propertyId}/tenants/{tenantId}
     * @allow (create) - Authenticated user with matching userId can create a tenant for a property.
     * @allow (get, list, update, delete) - Authenticated user with matching userId can read, update, or delete a tenant for a property.
     * @deny (create) - Authenticated user with non-matching userId cannot create a tenant for a property.
     * @deny (update, delete) - Authenticated user with non-matching userId cannot update or delete a tenant for a property.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId}/tenants/{tenantId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for rental payments associated with a property.
     * @path /users/{userId}/properties/{propertyId}/rentalPayments/{rentalPaymentId}
     * @allow (create) - Authenticated user with matching userId can create a rental payment for a property.
     * @allow (get, list, update, delete) - Authenticated user with matching userId can read, update, or delete a rental payment for a property.
     * @deny (create) - Authenticated user with non-matching userId cannot create a rental payment for a property.
     * @deny (update, delete) - Authenticated user with non-matching userId cannot update or delete a rental payment for a property.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId}/rentalPayments/{rentalPaymentId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for expenses associated with a property.
     * @path /users/{userId}/properties/{propertyId}/expenses/{expenseId}
     * @allow (create) - Authenticated user with matching userId can create an expense for a property.
     * @allow (get, list, update, delete) - Authenticated user with matching userId can read, update, or delete an expense for a property.
     * @deny (create) - Authenticated user with non-matching userId cannot create an expense for a property.
     * @deny (update, delete) - Authenticated user with non-matching userId cannot update or delete an expense for a property.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId}/expenses/{expenseId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for appointments associated with a property.
     * @path /users/{userId}/properties/{propertyId}/appointments/{appointmentId}
     * @allow (create) - Authenticated user with matching userId can create an appointment for a property.
     * @allow (get, list, update, delete) - Authenticated user with matching userId can read, update, or delete an appointment for a property.
     * @deny (create) - Authenticated user with non-matching userId cannot create an appointment for a property.
     * @deny (update, delete) - Authenticated user with non-matching userId cannot update or delete an appointment for a property.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId}/appointments/{appointmentId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for alerts associated with a property.
     * @path /users/{userId}/properties/{propertyId}/alerts/{alertId}
     * @allow (create) - Authenticated user with matching userId can create an alert for a property.
     * @allow (get, list, update, delete) - Authenticated user with matching userId can read, update, or delete an alert for a property.
     * @deny (create) - Authenticated user with non-matching userId cannot create an alert for a property.
     * @deny (update, delete) - Authenticated user with non-matching userId cannot update or delete an alert for a property.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId}/alerts/{alertId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for maintenance requests.
     * @path /users/{userId}/maintenanceRequests/{maintenanceRequestId}
     * @allow (create) - Authenticated user with matching userId can create a maintenance request.
     * @allow (get, list, update, delete) - Authenticated user with matching userId can read, update, or delete a maintenance request.
     * @deny (create) - Authenticated user with non-matching userId cannot create a maintenance request.
     * @deny (update, delete) - Authenticated user with non-matching userId cannot update or delete a maintenance request.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/maintenanceRequests/{maintenanceRequestId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}