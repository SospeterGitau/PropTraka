rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a document is sample data
    function isSampleData() {
      return resource.data.keys().hasAny(['isSampleData']) && resource.data.isSampleData == true;
    }

    // Helper function to check if user owns the document
    function isOwner() {
      return request.auth != null && 
             resource.data.keys().hasAny(['ownerId']) && 
             request.auth.uid == resource.data.ownerId;
    }

    // This rule matches any document in any collection.
    match /{document=**} {

      // Allow read if:
      // 1. User is authenticated AND document's ownerId matches their UID, OR
      // 2. Document is marked as sample data (isSampleData: true)
      allow read: if request.auth != null && (
        isOwner() ||
        isSampleData()
      );

      // A user can create a document if they are authenticated and EITHER:
      // 1. They are setting the ownerId to their own UID, OR
      // 2. They are creating sample data (isSampleData: true with no ownerId required)
      allow create: if request.auth != null && (
        request.resource.data.ownerId == request.auth.uid ||
        (request.resource.data.keys().hasAny(['isSampleData']) && request.resource.data.isSampleData == true)
      );

      // A user can update or delete a document if they are authenticated and EITHER:
      // 1. The document's ownerId matches their UID, OR
      // 2. The document is sample data they want to remove
      allow update, delete: if request.auth != null && (
        request.auth.uid == resource.data.ownerId ||
        isSampleData()
      );
    }
  }
}
