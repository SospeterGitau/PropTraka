
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check ownership
    function isOwner(docData) {
      return request.auth != null && request.auth.uid == docData.ownerId;
    }

    // Secure all top-level collections with the same ownership-based rules
    match /{collection}/{docId} {
      // READ (get): Allow if the user is the owner of the document.
      allow get: if isOwner(resource.data);

      // LIST (query): Allow if the user is querying for their own documents.
      // This rule requires that any query on the collection MUST include
      // a 'where("ownerId", "==", request.auth.uid)' clause.
      allow list: if request.auth != null && request.query.filters.size() == 1 && 'ownerId' in request.query.filters && request.query.filters.ownerId == request.auth.uid;

      // CREATE: Allow if the incoming document's ownerId matches the user's UID.
      allow create: if isOwner(request.resource.data);

      // UPDATE, DELETE: Allow if the user is the owner of the existing document.
      allow update, delete: if isOwner(resource.data);
    }
  }
}
