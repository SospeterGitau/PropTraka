/**
 * @fileoverview Firestore Security Rules for Rental Property Management App.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model, where each user has full control over their own data tree.
 *
 * Data Structure:
 * All data is nested under /users/{userId}, representing a user's private data.
 * Properties, Tenants, RentalPayments, Expenses, Appointments, and Alerts are stored as subcollections within each user's document.
 *
 * Key Security Decisions:
 * - Users can only access their own data.
 * - Listing operations are allowed only within a user's own data tree.
 * - Authorization decisions are based on the authenticated user's ID (`request.auth.uid`).
 *
 * Denormalization for Authorization:
 * - Subcollections (tenants, rentalPayments, etc.) contain a denormalized `ownerId` field, copied from the parent `property`.
 * - This eliminates the need for `get()` calls in security rules, ensuring atomic operations and easy debugging.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by a signed-in user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     * @param {string} userId The user ID to compare against.
     * @return {bool} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the existing owner of the document.
     * @param {string} userId The user ID to compare against.
     * @return {bool} True if the user is the owner and the document exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rule for /users/{userId}/properties/{propertyId}
     * @path /users/{userId}/properties/{propertyId}
     * @allow (create) - User A creates a new property under /users/A/properties/property1.
     * @allow (update) - User A updates property under /users/A/properties/property1.
     * @allow (delete) - User A deletes property under /users/A/properties/property1.
     * @allow (get) - User A gets property under /users/A/properties/property1.
     * @allow (list) - User A lists properties under /users/A/properties.
     * @deny (create) - User B tries to create a property under /users/A/properties.
     * @deny (update) - User B tries to update property under /users/A/properties/property1.
     * @deny (delete) - User B tries to delete property under /users/A/properties/property1.
     * @deny (get) - User B tries to get property under /users/A/properties/property1.
     * @deny (list) - User B tries to list properties under /users/A/properties.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == propertyId;
      allow update: if isExistingOwner(userId) && resource.data.id == request.resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for /users/{userId}/properties/{propertyId}/tenants/{tenantId}
     * @path /users/{userId}/properties/{propertyId}/tenants/{tenantId}
     * @allow (create) - User A creates a new tenant under /users/A/properties/property1/tenants/tenant1.
     * @allow (update) - User A updates tenant under /users/A/properties/property1/tenants/tenant1.
     * @allow (delete) - User A deletes tenant under /users/A/properties/property1/tenants/tenant1.
     * @allow (get) - User A gets tenant under /users/A/properties/property1/tenants/tenant1.
     * @allow (list) - User A lists tenants under /users/A/properties/property1/tenants.
     * @deny (create) - User B tries to create a tenant under /users/A/properties/property1/tenants.
     * @deny (update) - User B tries to update tenant under /users/A/properties/property1/tenants/tenant1.
     * @deny (delete) - User B tries to delete tenant under /users/A/properties/property1/tenants/tenant1.
     * @deny (get) - User B tries to get tenant under /users/A/properties/property1/tenants/tenant1.
     * @deny (list) - User B tries to list tenants under /users/A/properties/property1/tenants.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId}/tenants/{tenantId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == tenantId;
      allow update: if isExistingOwner(userId) && resource.data.id == request.resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for /users/{userId}/properties/{propertyId}/rentalPayments/{rentalPaymentId}
     * @path /users/{userId}/properties/{propertyId}/rentalPayments/{rentalPaymentId}
     * @allow (create) - User A creates a new rental payment under /users/A/properties/property1/rentalPayments/payment1.
     * @allow (update) - User A updates rental payment under /users/A/properties/property1/rentalPayments/payment1.
     * @allow (delete) - User A deletes rental payment under /users/A/properties/property1/rentalPayments/payment1.
     * @allow (get) - User A gets rental payment under /users/A/properties/property1/rentalPayments/payment1.
     * @allow (list) - User A lists rental payments under /users/A/properties/property1/rentalPayments.
     * @deny (create) - User B tries to create a rental payment under /users/A/properties/property1/rentalPayments.
     * @deny (update) - User B tries to update rental payment under /users/A/properties/property1/rentalPayments/payment1.
     * @deny (delete) - User B tries to delete rental payment under /users/A/properties/property1/rentalPayments/payment1.
     * @deny (get) - User B tries to get rental payment under /users/A/properties/property1/rentalPayments/payment1.
     * @deny (list) - User B tries to list rental payments under /users/A/properties/property1/rentalPayments.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId}/rentalPayments/{rentalPaymentId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == rentalPaymentId;
      allow update: if isExistingOwner(userId) && resource.data.id == request.resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for /users/{userId}/properties/{propertyId}/expenses/{expenseId}
     * @path /users/{userId}/properties/{propertyId}/expenses/{expenseId}
     * @allow (create) - User A creates a new expense under /users/A/properties/property1/expenses/expense1.
     * @allow (update) - User A updates expense under /users/A/properties/property1/expenses/expense1.
     * @allow (delete) - User A deletes expense under /users/A/properties/property1/expenses/expense1.
     * @allow (get) - User A gets expense under /users/A/properties/property1/expenses/expense1.
     * @allow (list) - User A lists expenses under /users/A/properties/property1/expenses.
     * @deny (create) - User B tries to create a expense under /users/A/properties/property1/expenses.
     * @deny (update) - User B tries to update expense under /users/A/properties/property1/expenses/expense1.
     * @deny (delete) - User B tries to delete expense under /users/A/properties/property1/expenses/expense1.
     * @deny (get) - User B tries to get expense under /users/A/properties/property1/expenses/expense1.
     * @deny (list) - User B tries to list expenses under /users/A/properties/property1/expenses.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId}/expenses/{expenseId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == expenseId;
      allow update: if isExistingOwner(userId) && resource.data.id == request.resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for /users/{userId}/properties/{propertyId}/appointments/{appointmentId}
     * @path /users/{userId}/properties/{propertyId}/appointments/{appointmentId}
     * @allow (create) - User A creates a new appointment under /users/A/properties/property1/appointments/appointment1.
     * @allow (update) - User A updates appointment under /users/A/properties/property1/appointments/appointment1.
     * @allow (delete) - User A deletes appointment under /users/A/properties/property1/appointments/appointment1.
     * @allow (get) - User A gets appointment under /users/A/properties/property1/appointments/appointment1.
     * @allow (list) - User A lists appointments under /users/A/properties/property1/appointments.
     * @deny (create) - User B tries to create a appointment under /users/A/properties/property1/appointments.
     * @deny (update) - User B tries to update appointment under /users/A/properties/property1/appointments/appointment1.
     * @deny (delete) - User B tries to delete appointment under /users/A/properties/property1/appointments/appointment1.
     * @deny (get) - User B tries to get appointment under /users/A/properties/property1/appointments/appointment1.
     * @deny (list) - User B tries to list appointments under /users/A/properties/property1/appointments.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId}/appointments/{appointmentId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == appointmentId;
      allow update: if isExistingOwner(userId) && resource.data.id == request.resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for /users/{userId}/properties/{propertyId}/alerts/{alertId}
     * @path /users/{userId}/properties/{propertyId}/alerts/{alertId}
     * @allow (create) - User A creates a new alert under /users/A/properties/property1/alerts/alert1.
     * @allow (update) - User A updates alert under /users/A/properties/property1/alerts/alert1.
     * @allow (delete) - User A deletes alert under /users/A/properties/property1/alerts/alert1.
     * @allow (get) - User A gets alert under /users/A/properties/property1/alerts/alert1.
     * @allow (list) - User A lists alerts under /users/A/properties/property1/alerts.
     * @deny (create) - User B tries to create a alert under /users/A/properties/property1/alerts.
     * @deny (update) - User B tries to update alert under /users/A/properties/property1/alerts/alert1.
     * @deny (delete) - User B tries to delete alert under /users/A/properties/property1/alerts/alert1.
     * @deny (get) - User B tries to get alert under /users/A/properties/property1/alerts/alert1.
     * @deny (list) - User B tries to list alerts under /users/A/properties/property1/alerts.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/properties/{propertyId}/alerts/{alertId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == alertId;
      allow update: if isExistingOwner(userId) && resource.data.id == request.resource.data.id;
      allow delete: if isExistingOwner(userId);
    }
  }
}