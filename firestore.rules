/**
 * @fileoverview Firestore Security Rules for Property Management App
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Only the owner of a document can read, create, update, or delete it.
 *
 * Data Structure:
 * The Firestore database consists of several top-level collections: 'properties', 'revenue', 'expenses', 'maintenanceRequests', and 'changelog'. Each document in these collections represents an individual entity and includes an 'ownerId' field.
 *
 * Key Security Decisions:
 * - **Ownership Enforcement**: All write operations are validated against the 'ownerId' field in the document, ensuring that only the owner can modify or delete data.
 * - **No User Listing**: There are no rules allowing listing all users. This prevents unauthorized discovery of user IDs.
 * - **Public Read (None)**: No collections are publicly readable.
 * - **Denormalization**: The 'ownerId' is present on each document to avoid expensive `get()` operations in the rules.
 *
 * Structural Segregation: All data is stored in top-level collections (e.g., 'properties', 'revenue', 'expenses').
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages access control for property documents.
     * @path /properties/{propertyId}
     * @allow (create) User with UID 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can create a property document with ownerId 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @deny (create) User with UID 'OtherUser' cannot create a property document with ownerId 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @allow (get, list) User with UID 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can read the property document if they are the owner.
     * @deny (get, list) User with UID 'OtherUser' cannot read the property document if they are not the owner.
     * @allow (update, delete) User with UID 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can update or delete the property document if they are the owner and the document exists.
     * @deny (update, delete) User with UID 'OtherUser' cannot update or delete the property document if they are not the owner.
     * @principle Enforces document ownership for writes.
     */
    match /properties/{propertyId} {
      allow get: if isSignedIn() && isOwner(resource.data.ownerId);
      allow list: if isSignedIn() && isOwner(propertyId);
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.ownerId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Manages access control for revenue transaction documents.
     * @path /revenue/{transactionId}
     * @allow (create) User with UID 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can create a revenue transaction document with ownerId 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @deny (create) User with UID 'OtherUser' cannot create a revenue transaction document with ownerId 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @allow (get, list) User with UID 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can read the revenue transaction document if they are the owner.
     * @deny (get, list) User with UID 'OtherUser' cannot read the revenue transaction document if they are not the owner.
     * @allow (update, delete) User with UID 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can update or delete the revenue transaction document if they are the owner and the document exists.
     * @deny (update, delete) User with UID 'OtherUser' cannot update or delete the revenue transaction document if they are not the owner.
     * @principle Enforces document ownership for writes.
     */
    match /revenue/{transactionId} {
      allow get: if isSignedIn() && isOwner(resource.data.ownerId);
      allow list: if isSignedIn() && isOwner(transactionId);
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.ownerId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Manages access control for expense transaction documents.
     * @path /expenses/{transactionId}
     * @allow (create) User with UID 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can create an expense transaction document with ownerId 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @deny (create) User with UID 'OtherUser' cannot create an expense transaction document with ownerId 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @allow (get, list) User with UID 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can read the expense transaction document if they are the owner.
     * @deny (get, list) User with UID 'OtherUser' cannot read the expense transaction document if they are not the owner.
     * @allow (update, delete) User with UID 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can update or delete the expense transaction document if they are the owner and the document exists.
     * @deny (update, delete) User with UID 'OtherUser' cannot update or delete the expense transaction document if they are not the owner.
     * @principle Enforces document ownership for writes.
     */
    match /expenses/{transactionId} {
      allow get: if isSignedIn() && isOwner(resource.data.ownerId);
      allow list: if isSignedIn() && isOwner(transactionId);
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.ownerId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Manages access control for maintenance request documents.
     * @path /maintenanceRequests/{requestId}
     * @allow (create) User with UID 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can create a maintenance request document with ownerId 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @deny (create) User with UID 'OtherUser' cannot create a maintenance request document with ownerId 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @allow (get, list) User with UID 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can read the maintenance request document if they are the owner.
     * @deny (get, list) User with UID 'OtherUser' cannot read the maintenance request document if they are not the owner.
     * @allow (update, delete) User with UID 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can update or delete the maintenance request document if they are the owner and the document exists.
     * @deny (update, delete) User with UID 'OtherUser' cannot update or delete the maintenance request document if they are not the owner.
     * @principle Enforces document ownership for writes.
     */
    match /maintenanceRequests/{requestId} {
      allow get: if isSignedIn() && isOwner(resource.data.ownerId);
      allow list: if isSignedIn() && isOwner(requestId);
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.ownerId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Manages access control for changelog entry documents.
     * @path /changelog/{logId}
     * @allow (create) User with UID 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can create a changelog entry document with ownerId 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @deny (create) User with UID 'OtherUser' cannot create a changelog entry document with ownerId 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1'.
     * @allow (get, list) User with UID 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can read the changelog entry document if they are the owner.
     * @deny (get, list) User with UID 'OtherUser' cannot read the changelog entry document if they are not the owner.
     * @allow (update, delete) User with UID 'Tu5oCEPnGXat4Rl6iLHUU0DxL4j1' can update or delete the changelog entry document if they are the owner and the document exists.
     * @deny (update, delete) User with UID 'OtherUser' cannot update or delete the changelog entry document if they are not the owner.
     * @principle Enforces document ownership for writes.
     */
    match /changelog/{logId} {
      allow get: if isSignedIn() && isOwner(resource.data.ownerId);
      allow list: if isSignedIn() && isOwner(logId);
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.ownerId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.ownerId);
    }
  }

  // Helper function to determine if the user is signed in.
  function isSignedIn() {
    return request.auth != null;
  }

  // Helper function to determine if the user is the owner.
  function isOwner(ownerId) {
    return isSignedIn() && request.auth.uid == ownerId;
  }

  // Helper function to determine if the user is the owner and the document exists.
  function isExistingOwner(ownerId) {
    return isOwner(ownerId) && resource != null;
  }
}