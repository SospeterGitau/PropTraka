/**
 * @file Firestore Security Rules
 * @core_philosophy This ruleset enforces a strict user-ownership model for properties, transactions, maintenance requests and change log entries.
 * All data is secured by the ownerId field.
 * @data_structure Top-level collections: /properties/{propertyId}, /revenue/{transactionId}, /expenses/{transactionId}, /maintenanceRequests/{requestId}, /changelog/{logId}.
 * Each document in these collections MUST have an ownerId field matching the authenticated user's UID.
 * @key_security_decisions Listing of the changelog collection has been explicitly denied.
 * @denormalization To simplify security rules, each document directly stores its ownerId, avoiding the need for complex lookups.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures property data, enforcing owner-only access.
     * @path /properties/{propertyId}
     * @allow (create) - Allows a user to create a property if the ownerId matches their UID.
     * @allow (update) - Allows a user to update a property if they are the owner.
     * @allow (delete) - Allows a user to delete a property if they are the owner.
     * @deny (create) - Denies creation if the ownerId does not match the user's UID.
     * @deny (update) - Denies updates if the user is not the owner or the document doesn't exist.
     * @deny (delete) - Denies deletion if the user is not the owner or the document doesn't exist.
     * @principle Enforces document ownership for writes.
     */
    match /properties/{propertyId} {
      function isOwner(ownerId) {
        return request.auth != null && request.auth.uid == ownerId;
      }
      function isExistingOwner(ownerId) {
        return isOwner(ownerId) && resource != null;
      }
      allow get: if true;
      allow list: if true;
      allow create: if isOwner(request.resource.data.ownerId);
      allow update: if isExistingOwner(resource.data.ownerId) && request.resource.data.ownerId == resource.data.ownerId;
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Secures revenue transaction data, enforcing owner-only access.
     * @path /revenue/{transactionId}
     * @allow (create) - Allows a user to create a revenue transaction if the ownerId matches their UID.
     * @allow (update) - Allows a user to update a revenue transaction if they are the owner.
     * @allow (delete) - Allows a user to delete a revenue transaction if they are the owner.
     * @deny (create) - Denies creation if the ownerId does not match the user's UID.
     * @deny (update) - Denies updates if the user is not the owner or the document doesn't exist.
     * @deny (delete) - Denies deletion if the user is not the owner or the document doesn't exist.
     * @principle Enforces document ownership for writes.
     */
    match /revenue/{transactionId} {
      function isOwner(ownerId) {
        return request.auth != null && request.auth.uid == ownerId;
      }
      function isExistingOwner(ownerId) {
        return isOwner(ownerId) && resource != null;
      }
      allow get: if true;
      allow list: if true;
      allow create: if isOwner(request.resource.data.ownerId);
      allow update: if isExistingOwner(resource.data.ownerId) && request.resource.data.ownerId == resource.data.ownerId;
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Secures expense transaction data, enforcing owner-only access.
     * @path /expenses/{transactionId}
     * @allow (create) - Allows a user to create an expense transaction if the ownerId matches their UID.
     * @allow (update) - Allows a user to update an expense transaction if they are the owner.
     * @allow (delete) - Allows a user to delete an expense transaction if they are the owner.
     * @deny (create) - Denies creation if the ownerId does not match the user's UID.
     * @deny (update) - Denies updates if the user is not the owner or the document doesn't exist.
     * @deny (delete) - Denies deletion if the user is not the owner or the document doesn't exist.
     * @principle Enforces document ownership for writes.
     */
    match /expenses/{transactionId} {
      function isOwner(ownerId) {
        return request.auth != null && request.auth.uid == ownerId;
      }
      function isExistingOwner(ownerId) {
        return isOwner(ownerId) && resource != null;
      }
      allow get: if true;
      allow list: if true;
      allow create: if isOwner(request.resource.data.ownerId);
      allow update: if isExistingOwner(resource.data.ownerId) && request.resource.data.ownerId == resource.data.ownerId;
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Secures maintenance request data, enforcing owner-only access.
     * @path /maintenanceRequests/{requestId}
     * @allow (create) - Allows a user to create a maintenance request if the ownerId matches their UID.
     * @allow (update) - Allows a user to update a maintenance request if they are the owner.
     * @allow (delete) - Allows a user to delete a maintenance request if they are the owner.
     * @deny (create) - Denies creation if the ownerId does not match the user's UID.
     * @deny (update) - Denies updates if the user is not the owner or the document doesn't exist.
     * @deny (delete) - Denies deletion if the user is not the owner or the document doesn't exist.
     * @principle Enforces document ownership for writes.
     */
    match /maintenanceRequests/{requestId} {
      function isOwner(ownerId) {
        return request.auth != null && request.auth.uid == ownerId;
      }
      function isExistingOwner(ownerId) {
        return isOwner(ownerId) && resource != null;
      }
      allow get: if true;
      allow list: if true;
      allow create: if isOwner(request.resource.data.ownerId);
      allow update: if isExistingOwner(resource.data.ownerId) && request.resource.data.ownerId == resource.data.ownerId;
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

      /**
       * @description Secures change log entry data, enforcing owner-only access.
       * @path /changelog/{logId}
       * @allow (create) - Allows a user to create a change log entry if the ownerId matches their UID.
       * @allow (get) - Allows a user to get a change log entry.
       * @deny (list) - Listing change log entries is explicitly denied.
       * @allow (update) - Allows a user to update a change log entry if they are the owner.
       * @allow (delete) - Allows a user to delete a change log entry if they are the owner.
       * @deny (create) - Denies creation if the ownerId does not match the user's UID.
       * @deny (update) - Denies updates if the user is not the owner or the document doesn't exist.
       * @deny (delete) - Denies deletion if the user is not the owner or the document doesn't exist.
       * @principle Enforces document ownership for writes and restricts listing.
       */
    match /changelog/{logId} {
      function isOwner(ownerId) {
        return request.auth != null && request.auth.uid == ownerId;
      }
      function isExistingOwner(ownerId) {
        return isOwner(ownerId) && resource != null;
      }
      allow get: if true;
      allow list: if false;
      allow create: if isOwner(request.resource.data.ownerId);
      allow update: if isExistingOwner(resource.data.ownerId) && request.resource.data.ownerId == resource.data.ownerId;
      allow delete: if isExistingOwner(resource.data.ownerId);
    }
  }
}